# upload_album.py - –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞

import os
import mimetypes
import dotenv
from vercel_blob import put
from dotenv import load_dotenv
from mutagen.mp3 import MP3
from mutagen.wave import WAVE
from mutagen import MutagenError

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.load_dotenv('.env.development.local')

MUSIC_DIR = 'music'

def get_audio_info(file_path):
    """
    –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞—É–¥–∏–æ—Ñ–∞–π–ª–µ
    """
    try:
        if file_path.lower().endswith('.mp3'):
            audio = MP3(file_path)
            return {
                'duration': audio.info.length,
                'bitrate': audio.info.bitrate,
                'title': audio.get('TIT2', ['Unknown'])[0],
                'artist': audio.get('TPE1', ['Unknown'])[0],
                'album': audio.get('TALB', ['Unknown'])[0]
            }
        elif file_path.lower().endswith('.wav'):
            audio = WAVE(file_path)
            return {
                'duration': audio.info.length,
                'bitrate': audio.info.bitrate,
                'title': 'Unknown',
                'artist': 'Unknown',
                'album': 'Unknown'
            }
    except MutagenError:
        pass
    
    return None

def upload_album(local_album_path, target_blob_path=None):
    """
    –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º –≤ blob —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    """
    print(f"=== –ó–ê–ì–†–£–ó–ö–ê –ê–õ–¨–ë–û–ú–ê ===")
    print(f"–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å: {local_album_path}")
    
    if not os.path.exists(local_album_path):
        print(f"‚ùå –ü–∞–ø–∫–∞ '{local_album_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return False
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
    audio_files = []
    for root, dirs, files in os.walk(local_album_path):
        for filename in files:
            if filename.startswith('.'):
                continue
            
            if filename.lower().endswith(('.mp3', '.wav', '.flac', '.m4a', '.ogg')):
                local_path = os.path.join(root, filename)
                audio_files.append({
                    'local_path': local_path,
                    'filename': filename,
                    'size': os.path.getsize(local_path)
                })
    
    if not audio_files:
        print(f"‚ùå –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ '{local_album_path}'")
        return False
    
    print(f"–ù–∞–π–¥–µ–Ω–æ {len(audio_files)} –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤:")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
    total_size = 0
    for file in audio_files:
        audio_info = get_audio_info(file['local_path'])
        size_mb = file['size'] / (1024 * 1024)
        total_size += file['size']
        
        print(f"  üìÅ {file['filename']} ({size_mb:.1f} MB)")
        if audio_info:
            duration_min = audio_info['duration'] / 60
            print(f"     üéµ {audio_info['title']} - {audio_info['artist']}")
            print(f"     ‚è±Ô∏è  {duration_min:.1f} –º–∏–Ω, {audio_info['bitrate']} kbps")
    
    total_size_mb = total_size / (1024 * 1024)
    print(f"\nüìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {total_size_mb:.1f} MB")
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    confirm = input(f"\n‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å {len(audio_files)} —Ñ–∞–π–ª–æ–≤? (y/N): ")
    if confirm.lower() != 'y':
        print("‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞")
        return False
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã
    uploaded_count = 0
    failed_count = 0
    
    for i, file in enumerate(audio_files, 1):
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –≤ blob
        if target_blob_path:
            blob_path = target_blob_path + '/' + file['filename']
        else:
            blob_path = file['local_path'].replace("\\", "/")
        
        print(f"\n[{i}/{len(audio_files)}] –ó–∞–≥—Ä—É–∑–∫–∞: {file['filename']}")
        print(f"  –ü—É—Ç—å –≤ blob: {blob_path}")
        
        try:
            with open(file['local_path'], 'rb') as f:
                file_content = f.read()
                
                content_type, _ = mimetypes.guess_type(file['local_path'])
                if content_type is None:
                    content_type = 'application/octet-stream'

                blob_result = put(blob_path, file_content, options={
                    'content_type': content_type,
                    'allowOverwrite': True
                })
                
                print(f"  ‚úÖ –£—Å–ø–µ—à–Ω–æ! URL: {blob_result['url']}")
                uploaded_count += 1
                
        except Exception as e:
            print(f"  ‚ùå –û–®–ò–ë–ö–ê: {e}")
            failed_count += 1
    
    print(f"\n=== –†–ï–ó–£–õ–¨–¢–ê–¢ –ó–ê–ì–†–£–ó–ö–ò ===")
    print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {uploaded_count}")
    print(f"‚ùå –û—à–∏–±–æ–∫: {failed_count}")
    print(f"üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {total_size_mb:.1f} MB")
    
    if uploaded_count > 0:
        print("=== –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")
        return True
    else:
        print("=== –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–í–ê–õ–ï–ù–ê ===")
        return False

def upload_single_album_folder(album_folder_name, custom_blob_path=None):
    """
    –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º –∏–∑ –ø–∞–ø–∫–∏ music/
    """
    local_path = os.path.join(MUSIC_DIR, album_folder_name)
    
    if custom_blob_path:
        blob_path = custom_blob_path
    else:
        blob_path = f"music/{album_folder_name}"
    
    return upload_album(local_path, blob_path)

if __name__ == '__main__':
    # –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º –∏–∑ –ø–∞–ø–∫–∏ music/
    upload_single_album_folder("n√ºkorochki/Album. Grenzg√§nger")
    
    # –í–∞—Ä–∏–∞–Ω—Ç 2: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º –∏–∑ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –ø–∞–ø–∫–∏
    # upload_album("C:/MyMusic/New Album", "music/artist/new_album")
    
    # –í–∞—Ä–∏–∞–Ω—Ç 3: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø—É—Ç–µ–º –≤ blob
    # upload_single_album_folder("n√ºkorochki/Album. Grenzg√§nger", "music/corrected_albums/grenzganger")
